<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Resizer and Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        .image-preview {
            max-width: 100%;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- First Row: Image preview and resize controls -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h5>Image Preview</h5>
                <img id="imagePreview" src="https://via.placeholder.com/300" alt="Preview" class="image-preview img-fluid border">
            </div>
            <div class="col-md-6">
                <h5>Resize Controls</h5>
                <div class="mb-3">
                    <button class="btn btn-primary btn-sm mb-1" onclick="resizeImage(200, 200)">200x200</button>
                    <button class="btn btn-primary btn-sm mb-1" onclick="resizeImage(400, 400)">400x400</button>
                    <button class="btn btn-primary btn-sm mb-1" onclick="resizeImage(600, 600)">600x600</button>
                </div>
                <div>
                    <label for="customWidth" class="form-label">Custom Width:</label>
                    <input type="number" id="customWidth" class="form-control mb-2" placeholder="Enter width">
                    <label for="customHeight" class="form-label">Custom Height:</label>
                    <input type="number" id="customHeight" class="form-control mb-2" placeholder="Enter height">
                    <button class="btn btn-success" onclick="applyCustomResize()">Resize</button>
                </div>
            </div>
        </div>

        <!-- Second Row: Map with draggable markers -->
        <div class="row mb-4">
            <div class="col-12">
                <h5>Map</h5>
                <div class="mb-2">
                    <button class="btn btn-primary" onclick="useOnlineMap()">Online Map</button>
                    <button class="btn btn-secondary" onclick="uploadImage()">Upload Map Image</button>
                </div>
                <div id="map"></div>
                <div class="mt-3">
                    <h6>Pin Coordinates:</h6>
                    <p>Image Location: <span id="imagePinCoord">N/A</span></p>
                    <p class="corner-coord" id="cornerPins" style="display: none;">
                        Top-Left: <span id="topLeftCoord">N/A</span><br>
                        Top-Right: <span id="topRightCoord">N/A</span><br>
                        Bottom-Left: <span id="bottomLeftCoord">N/A</span><br>
                        Bottom-Right: <span id="bottomRightCoord">N/A</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Third Row: Save Button -->
        <div class="row">
            <div class="col-12 text-center">
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, imagePin, cornerMarkers = {};

        // Initialize Leaflet Map
        function initMap(tileLayerURL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png') {
            if (map) map.remove(); // Remove the previous map instance

            map = L.map('map', {
                crs: L.CRS.EPSG3857 // Default CRS for Leaflet
            }).setView([37.7749, -122.4194], 12);

            L.tileLayer(tileLayerURL, {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18,
            }).addTo(map);

            // Add the single draggable pin for image location
            if (imagePin) map.removeLayer(imagePin);
            imagePin = L.marker([37.7749, -122.4194], { draggable: true }).addTo(map);
            imagePin.on('dragend', () => updateCoords('imagePin'));
            updateCoords();
        }

        // Upload Image and Add Corner Markers
        function uploadImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imageURL = e.target.result;

                        // Initialize map with simple CRS for image-based maps
                        map.remove();
                        map = L.map('map', {
                            crs: L.CRS.Simple
                        }).setView([0, 0], 0);

                        const bounds = [[-100, -100], [100, 100]];
                        L.imageOverlay(imageURL, bounds).addTo(map);
                        map.fitBounds(bounds);

                        // Add corner markers
                        addCornerMarkers();
                        updateCoords();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function addCornerMarkers() {
            document.getElementById('cornerPins').style.display = 'block'; // Show corner pins section

            const corners = {
                topLeft: [-100, -100],
                topRight: [-100, 100],
                bottomLeft: [100, -100],
                bottomRight: [100, 100]
            };

            // Add red draggable markers for corners
            Object.keys(corners).forEach(corner => {
                if (cornerMarkers[corner]) map.removeLayer(cornerMarkers[corner]);
                cornerMarkers[corner] = L.marker(corners[corner], {
                    draggable: true,
                    icon: L.icon({
                        iconUrl: 'https://via.placeholder.com/20/FF0000/FFFFFF?text=.',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                cornerMarkers[corner].on('dragend', () => updateCoords(corner));
            });
        }

        function updateCoords(markerKey) {
            if (markerKey === 'imagePin') {
                document.getElementById('imagePinCoord').textContent =
                    `${imagePin.getLatLng().lat.toFixed(4)}, ${imagePin.getLatLng().lng.toFixed(4)}`;
            } else if (cornerMarkers[markerKey]) {
                document.getElementById(`${markerKey}Coord`).textContent =
                    `${cornerMarkers[markerKey].getLatLng().lat.toFixed(4)}, ${cornerMarkers[markerKey].getLatLng().lng.toFixed(4)}`;
            } else {
                updateCoords('imagePin');
                Object.keys(cornerMarkers).forEach(key => updateCoords(key));
            }
        }

        // Save Settings
        function saveSettings() {
            const positions = {
                imagePin: imagePin.getLatLng(),
                topLeft: cornerMarkers.topLeft ? cornerMarkers.topLeft.getLatLng() : null,
                topRight: cornerMarkers.topRight ? cornerMarkers.topRight.getLatLng() : null,
                bottomLeft: cornerMarkers.bottomLeft ? cornerMarkers.bottomLeft.getLatLng() : null,
                bottomRight: cornerMarkers.bottomRight ? cornerMarkers.bottomRight.getLatLng() : null
            };
            console.log('Saved Marker Positions:', positions);
            alert('Settings Saved! Check console for marker positions.');
        }

        // Resize Image
        function resizeImage(width, height) {
            const img = document.getElementById('imagePreview');
            img.style.width = width + 'px';
            img.style.height = height + 'px';
        }

        function applyCustomResize() {
            const width = document.getElementById('customWidth').value;
            const height = document.getElementById('customHeight').value;
            resizeImage(width, height);
        }

        // Default to online map on load
        window.onload = () => useOnlineMap();
    </script>
</body>
</html>

